name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Extract version from tag
        id: version
        shell: bash
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version extracted from tag: $VERSION"
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Pillow for icon generation
        run: pip install Pillow
      
      - name: Generate and Validate icon.ico
        shell: bash
        run: |
          echo "=== Generating icon.ico ==="
          python tools/make_icon.py
          
          # Validate result
          if [ ! -f "build-resources/icon.ico" ]; then
            echo "ERROR: icon.ico was not generated!"
            exit 1
          fi
          
          SIZE=$(stat -c%s "build-resources/icon.ico" 2>/dev/null || stat -f%z "build-resources/icon.ico")
          echo "icon.ico size: $SIZE bytes"
          
          if [ "$SIZE" -lt 1000 ]; then
            echo "ERROR: icon.ico too small ($SIZE bytes). Invalid file!"
            exit 1
          fi
          
          echo "[OK] icon.ico is valid!"
      
      - name: Install Python dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build Backend (PyInstaller)
        run: |
          cd backend
          python build_backend.py
      
      - name: Verify Backend Build
        shell: pwsh
        run: |
          if (!(Test-Path "desktop-build/backend/nucleo-backend.exe")) {
            Write-Error "Backend build failed - nucleo-backend.exe not found"
            Get-ChildItem -Recurse desktop-build
            exit 1
          }
          $size = (Get-Item "desktop-build/backend/nucleo-backend.exe").Length / 1MB
          Write-Host "[OK] nucleo-backend.exe generated: $([math]::Round($size, 2)) MB"
      
      - name: Install Node dependencies
        run: |
          npm install
          cd frontend
          yarn install
      
      - name: Set version in package.json
        shell: bash
        run: |
          npm pkg set version="${{ steps.version.outputs.VERSION }}"
          echo "Version set in package.json: ${{ steps.version.outputs.VERSION }}"
      
      - name: Build Frontend
        env:
          REACT_APP_VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          cd frontend
          yarn build
      
      - name: Verify Frontend Build
        shell: pwsh
        run: |
          if (!(Test-Path "frontend/build/index.html")) {
            Write-Error "Frontend build failed - index.html not found"
            exit 1
          }
          Write-Host "[OK] Frontend build complete"
      
      - name: Build Electron App (NSIS Installer)
        run: npm run dist:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify Installer
        shell: pwsh
        run: |
          Get-ChildItem dist
          if (!(Test-Path "dist/Nucleo-Setup.exe")) {
            Write-Error "Installer not found: Nucleo-Setup.exe"
            exit 1
          }
          $size = (Get-Item "dist/Nucleo-Setup.exe").Length / 1MB
          Write-Host "[OK] Nucleo-Setup.exe generated: $([math]::Round($size, 2)) MB"
      
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          files: dist/Nucleo-Setup.exe
          name: Nucleo v${{ steps.version.outputs.VERSION }}
          body: |
            ## Nucleo v${{ steps.version.outputs.VERSION }}
            
            ### Installation
            1. Download `Nucleo-Setup.exe`
            2. Run the installer
            3. Nucleo will appear in the Start Menu
            
            ### First access
            - Login: `admin`
            - Password: `admin`
            - Change the password on first login!
            
            ### Data locations
            - Database: `%APPDATA%\nucleo\nucleo.db`
            - Logs: `%APPDATA%\nucleo\logs\nucleo.log`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
